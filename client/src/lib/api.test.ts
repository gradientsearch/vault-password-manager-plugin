import { expect, test } from 'vitest';
import { Api } from './api';
import { buildUUK, bytesToHex, type UUK } from './uuk';
import { VITE_VAULT_TOKEN } from '$env/static/private';
import { _convertCase, revertCase } from './jsonKey';

test('api', async () => {
	//test.skip()
	let api = new Api(VITE_VAULT_TOKEN, 'http://localhost:8200', 'pwmanager');
	let json = await api.tokenLookup();

	const textEncoder = new TextEncoder();
	let password = textEncoder.encode('typingcats');
	let mount = textEncoder.encode('pwmanager');

	let secretKey = crypto.getRandomValues(new Uint8Array(16));

	let entityID = json != undefined ? json['data']['entity_id'] : crypto.randomUUID();

	let uuk = await buildUUK(password, mount, secretKey, new TextEncoder().encode(entityID));

	let err = await api.register(uuk);
});

test('uuk', ()=>{

    let json  = '{"request_id":"6a954c89-1bd3-34f3-046a-7f6ca3e46668","lease_id":"","renewable":false,"lease_duration":0,"data":{"entity_id":"39a77ff4-ef98-d6d3-ed82-39a6bfbd76a1","uuk":{"enc_pri_key":{"cty":"","data":"5954b84a31961a0889699601f63328cf67d7103d5b27e8c07e0a5a2b4eb9b07b4df4d15773a1b61722288790d7407622fe68e30d50aa2f33a2f1055e80298058b89d00f0090a73319a2628d3d89ace675a14b294933a111f2e7f0aaf545d5afa5cc57d0ac311078de5ef30fd0abe6354dda0ff97dd4e38cc39d422628e99475893635128139025916f233407e1e219300371039cf2cd9574c0151a97bc0f4181fa4563b622fbfdd007112039b29b01923db1ae89134880ee80a7a641fafe1df63fd54d46698cc2a1b4f9c6d965e62703a82d35c0e56a41bd7ff6529480cc09555a9d9a728a369bbb11d7806c9a2434f36a8d452ff9f3b86fe1b9d75e596234896d64d98c7deab8c2d297d616ce8951f7704f56784d22a5f3410d194f93246773f6a09fd08413491cb6b76288c36315576c19d2afe6cd396d46c21273a18404adc65772f4def8f25442c0e0169719148f65c180f0fc7d567c397cd4b97f9b2310c089de60f82871f287ce2c7eac9d381d2716394cea1d79d5265560f2094b0c55102e35277f4cc1521e4806f2eab7664b91689177f8bb9d648a30635ccc7504c9e8d028a0a9d57ed15e1bb22396530c5fca0aae9c0acb0e00fb11af0aa7910d9391b9af8cdef72e3a7936ce44613d3aeff3ab0f58c07259563f4d60b618f023623f2bdd49955f159d1e880fce615e3e36e8ce793206c169842eea4df22a4319100f8e03718d6ffb29d7acd32efeb3a2ffc750107c581e41bd1de688dfd9c79d8a2d868ee3c5a8a920b7f41dcf56498159106ba959029243961503d9b3916b18b8b14cf1c7d1a5590c995b498df80e66b6dc6f59d85d0c8659550201e00992332679d6a214f87e0cbe433c8cbcc3e8843ee7760c36d6451e29fc8ac80f54369aad0fda1fd00697f6e8a3b6e82a0870b05adf7df80ae338a534ff15d807efc96de3b2ab70bd7456715f9add361700f9dd0b698fafecbe8feb92567b97a478801dc63efb217c8f6d2f49ef50a1a3b6e7d4d10301d8c22a893d083d209051de7f68c0151f880b70093d7a97376fd9b8dbfedbbb710e34a65b4b6040b7faf59ed7c351a7c3d8da007e34b4c2f53393d7e99b5a31db321d51a69f742028e11c0ad2c06caab9362684ee0709a564c86a23ad9991c1e3e54031bc6c9f39c1be480531e0a32d7231f37ee7654b476217ce4beca7db9262f0acf7da96dbdd08470ea027924d5b9a7e8eb0821803e8d88e3b9ad62c64ac529943297409a99d723504f60d9defce552bb11aba4f757fb8fbafcb28c3938399d1938b09e71245c45821c6774c89fa9235d908f025b689aa51278a90237ed58e893c3738d76e8a783de70d67d589772679bdcfeeedbfd60c74aaacacf4ea0ea279bc3baf845f3b84be4ef651880282c2c11f410441e19df3756191a8e478b177e2f2120cd836808691f6b02d5edf0af0aa4dd09fb2b7b45a5833e0d003889c7a92d5e6d494ba3fff6a735c5f568c5688bc3ea7556dbac9fa75785532d4c1b7deb3749c9bd5eadc42b16bd08b355c7c1111cf454ad1e1a6ff0f050525c0a6bd6386cc33d6d989777bfacff48b1953fb57528a6e9de01a55da7b437ad29f8d7a918c549db21d9ccaade34ebab402e9772a31107f6f53259df5224a2c7ca35c05639f5647541f132c84c28738cc02387feac613fd6c62848f4e503fd7a40f9f69392ef9d4d06935c44b980dc04d570add37ea4cb1ccdfdf8f0e930cdd8c0a657a8d9ed9b432753bfcabd38790777fd299bc5b437be55562f094fb470a7d34e3b1c0cce69d5dbb541165f1c1aa3531f8841c0d03688e7729f620466de4163432cb85e780f3e16e636822c0f96dcb842816bc67d30d6487895b1228736f769be2c0c80ee3e40f0a2f9cd5440db1ec1192ce5774c47605e90f24973fa578f6f2ae79a125706201c86a9bb9c670d65e56b07b4c8018061bffcd22c0ac7e2c227085e0176f389f4ced0e7bf8cfb75d43643a5652fc839493ae54822a4f0b421815b6d851d9130c471e2103c47a1c8e6cfcdb9dbccf04b1be0793930bee821a1606069196613f5494ecfd2c6eef1b34e15b516c6d49ee72656ac2a8483526fcd85c9e462a17955e12929d6c4a6675eb27050380ed0ae39c857361b2bdd440f6c136e012d31f7e02924cf37f2511599ac68c151fbb7a1cb86c7faacb61b3ec5314d032da7c8b108239876ac2b5071aa1b9cb4990d56263e0eae5a03344fc5c6e41e3178f0f4e7b9273549e49a51f22cbf433070f5f3bffdce16bea6df966702c09aadf2b38ab09e275aef84e00d16b4ae236bdb5ef827b7c294e15a7d785fd819930af3d44837426444cce7a6daa3fe7ca3be78ddb5f30b22700e61444a2a0351cbec37dcdbd6dea4724517d400414f7962721a934eb3b7b5b5ff866fa0a63d2655bf2651c75ad0fd17063685825f682de557591f38ad1835f3448f184ce36ad1a40c04b5c5b5fc98d492cc18fe88bb0db7cdbe743b37ff44243fd690513d95291c54295f6d73fc7fd19e3a7eb7159a83ada7d72aa1801cc23e72aa989e4be1fbded6b1fa9d967c798182b3513497a5dcbd15285f4872faa982a2470db16480476089a735aef8bfda6170ffebf08cf211161e4a09d46d6491664b9431f5d543627fb1315ed860202dd312baf10b46255a6d071ccc03189a0fa7103d94f945197d9357edfee460a15c39460105aaf1c02bb8f1c2c9c04d2a575f1493b7133a92f86a5ebabdf27759443caccee4a6df73c1b1cf0b20a4d1f87d755d688ff4bcc890f6a10ac650184ba81402599f0658ffface3780be380e0ddc77797aae7b929c8834247edab70161660ff4be167e5c62c3c1de10ceb87abbdb2fbbb3f750f1594b781f9e298b080c47494d758f603c16f374a88adb2a8b41e5e86e017e023272de07dcc11be2cf303aa6de477d12899c2c44b5d779aa716abf3369562eccf395fff6be5b58d5eb3af12c0b7e962afd866d8243d43e617150d9a34cadd2d285bbd4d5923ee7264801b8d014f1219f8fd60774108a665d0041391e2277d276c03fd7f5d4facb86ff3ec9a90476a58940beb06575fd71b001e4ab7ca5fdeb8ebcfd735641cc673351d8f0e08c2fdff50bb37967e4d514fd3a60cdf8ad6477350328115cc3f06dbd1412a550c80239170c1621895218e21c0c573c1849e68a7097abd976f8e1da293685ea8a7ab050326e756a2b7cfd5333de3a97cfad7512ffdf0bbf653fa972dcd0414532317ae4e673686ad25a513bd6f5abe4ee8b3a7ea5aaf686f053085a2772c6424ad5334bfd1f4d2b7a3816645c308b1914272545e84fb11f5020fe5235f2cf51c2f6b609e0c51b6964b84a9d7630f2778d1362eb0662e752bd1657cbb4a453963667a0ca22bf33237881e878459772badb8aeef33cd5f9c170884f5ccf9eec0a317b3bc8359a99ef82913b06f707474eb6623fde14a52b5127807b58d251833b9edeaf54f53604721c9c5446cb6b5d792e528ddc0b5ccd951e470d698bf20f5b289c095a0f560aadcd9309875afd707a55e2a0ec37dbe16b4c6f016e55ff397abe91b69fbb38086f4790467891cfb6241c3f9310bbda696cc82df43b55be4c9a8727b5e09006568b4da560e635856ef63ac919139b50b9364765bb9b2f3901b46eb81928caa3e801b541506d53b23b567a31b20471a6ee5a7e37fc2fcac75a69632677496004b83ea99b16032ca028892d0e6f71a30bf52b2aa36249c1edf0dce203fba02454bca434bacb29347280999a9e96838db5d920fba2199fc4b6d88d9fc475a7c81cbc53579d39064e4d06a9e00df0df2d6bc59f02a9b3792b5ed53ba33da130704dc87f5734be9d6ac46b5b6ec377c1b0b418facab6b1b4688654b580c7620035698fe0a7f25c60654b787b111ce752ccd18d70664d4c366f34d8f5730bdc53f0ae5b36b0dfc395b56d246a743dd333b98766c94e2871b1dbd0bd2e1ac48528254a1ca0fc206d70edb03e34fdf5aa78cbd80b3971ca454363b4761bea40321d02fb59a3dec668bd82dad4b36ac05fa388a037794f3568651ae58dc3f5f5537eb9b2728f3c5baa67e0eb790eae0deded5c7cb22f172b5b0c369a656f3e6e596d58b40420966e0a7d3d9459fc3b5ed732d8e8e3fc3ec4132a9600b9db878aaa3429a98107cbf578931b27693fac126807fdc2923059e85c560018b5601722ae3aa9276c309e2c26de702d437ba6e685310acfa938b33834ee750926bac2ebd39d873534a41d0a5cbbbaa76a66b55de47cf28aeebd6ef721c41261ca0c03d3ce2e999c74226f1dbf48cb2957c056ec68b7beccf11c1f7e8bdaac0b8db99a0cbeb48a3777e1d33fc9842bd0722d4cbc1caa16a6dd8b9be4234215bcfd16b06aa9a84df7506bd2596c1283c1c9e4ea83f04cdca4472f404492b913ed8774ce91d85aa81b619f2c1a51d785e4cbb55a1fb1c3445b84cb755a4e47e0f6eb431c92580fd7c8e50793d5a1ebe8d8f01a8724e8148b3af80d5f77e54a3c6052acb14d5f1dbe2bc1e42f33a12b961d659487a88195277dfb4c37c7e300d7bcca273","enc":"A256GCM","iv":"1515acbce563840fd038634a","kid":"593e2b2c-c687-4618-9f89-36b2076286ac"},"enc_sym_key":{"alg":"pbkdf2-hkdf","cty":"","data":"7ec4d9a72c4da21f32d17fbac84eb602baf3c7a4a497f9b95ec774ef41d08ff5679cc663ae0cbac2472059342fc24563","enc":"A256GCM","iv":"3649b019d0f91b6e9f285dbc","kid":"593e2b2c-c687-4618-9f89-36b2076286ac","p2c":0,"p2s":""},"encrypted_by":"mp","pub_key":{"data":"7b22616c67223a225253412d4f4145502d323536222c2265223a2241514142222c22657874223a747275652c226b65795f6f7073223a5b22656e6372797074225d2c226b7479223a22525341222c226e223a2236496443577a74364b4c3272657156667778787a61624f475951614f6d43447359646a344e6353732d2d6a48626b663959546c307351504f31476356764f7a65426756594a5932365341504c4956794f4f7654655f7372424a5a56743555434b71776e76772d4453683464773162614b5771744934485862724652505a6768615a48776f6f39644e466c625133554c717436526447547064424644565a49584d673435656f56464d6b576837493755536b5a62694c7133567766487331767a5471696b6f78587674617532734a334773784b324c346c325a754b6d4567744678483551587a424e546547795238506f76534a7842676576574a444974692d5649363465763465364b76433130554a71735358674c3450426565686b6b59746b7079557271396733694e4c574d514e4b555f6444794b43775875346e4c674e634a75414a374d35345f6a467571566754313938585071505749326a494f6f6d67664164676b704d746c655172476f3550626a3348476c68436f66474c576d754e6b2d34477a584c386f626c3761577a66715a74456a446e4b4132345577693637783971434769376d3173645f776433507a547331713669456866414d474b615255314850726d7958465936486a795757594d5663444b2d695833487874725049704d79632d7245366e624b555f463653442d5248552d78647947364778667454446c4a4d7273395a4456664a78713645664851752d6c397962454d7568707849494751576733587233453568634932546f67567251447458324363704e6f756557704c6b3732324370447674546a4d433370516d626834454b7447687143596c6f506e6a4934506e364e5a375464617571755475383054766f4d746162437a5756732d5862395f514f2d636274335946514530734e716f78393372636a36337570574f50784831676b794f55227d","e":"AQAB","kid":"593e2b2c-c687-4618-9f89-36b2076286ac","kty":"RSA","n":"6IdCWzt6KL2reqVfwxxzabOGYQaOmCDsYdj4NcSs--jHbkf9YTl0sQPO1GcVvOzeBgVYJY26SAPLIVyOOvTe_srBJZVt5UCKqwnvw-DSh4dw1baKWqtI4HXbrFRPZghaZHwoo9dNFlbQ3ULqt6RdGTpdBFDVZIXMg45eoVFMkWh7I7USkZbiLq3VwfHs1vzTqikoxXvtau2sJ3GsxK2L4l2ZuKmEgtFxH5QXzBNTeGyR8PovSJxBgevWJDIti-VI64ev4e6KvC10UJqsSXgL4PBeehkkYtkpyUrq9g3iNLWMQNKU_dDyKCwXu4nLgNcJuAJ7M54_jFuqVgT198XPqPWI2jIOomgfAdgkpMtleQrGo5Pbj3HGlhCofGLWmuNk-4GzXL8obl7aWzfqZtEjDnKA24Uwi67x9qCGi7m1sd_wd3PzTs1q6iEhfAMGKaRU1HPrmyXFY6HjyWWYMVcDK-iX3HxtrPIpMyc-rE6nbKU_F6SD-RHU-xdyG6GxftTDlJMrs9ZDVfJxq6EfHQu-l9ybEMuhpxIIGQWg3Xr3E5hcI2TogVrQDtX2CcpNoueWpLk722CpDvtTjMC3pQmbh4EKtGhqCYloPnjI4Pn6NZ7TdauquTu80TvoMtabCzWVs-Xb9_QO-cbt3YFQE0sNqox93rcj63upWOPxH1gkyOU"},"uuid":"593e2b2c-c687-4618-9f89-36b2076286ac"}},"wrap_info":null,"warnings":null,"auth":null,"mount_type":"pwmanager"}'
    let obj = JSON.parse(json)
	let uuk = revertCase<UUK>(obj['data']['uuk'], false)
})